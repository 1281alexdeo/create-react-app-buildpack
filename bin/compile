#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# Fail immediately on non-zero exit code.
set -e
# Fail immediately on non-zero exit code within a pipeline.
set -o pipefail
# Fail on undeclared variables.
set -u
# Debug, echo every command
#set -x

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BP_DIR=`cd $(dirname $0); cd ..; pwd`

url=https://github.com/heroku/heroku-buildpack-nodejs.git
branch=""
dir=$(mktemp -t buildpackXXXXX)
rm -rf $dir

echo "-----> Setup app"
shopt -s dotglob
react_app_compat_with_custom_server=false

if [ -f "$BUILD_DIR/react-ui/package.json" ]
then
  echo '       Found `react-ui/package.json`'
  react_app_compat_with_custom_server=true
else
  echo '       Moving React app into place'
  react_app_compat_with_custom_server=false
  mkdir -p $CACHE_DIR/original-build
  mv $BUILD_DIR/* $CACHE_DIR/original-build/
  mkdir -p $BUILD_DIR/react-ui
  mv $CACHE_DIR/original-build/* $BUILD_DIR/react-ui/
fi

if [ "$react_app_compat_with_custom_server" = true -a -f "$BUILD_DIR/server/index.js" -a -f "$BUILD_DIR/package.json" ]
then
  echo '       Found `server/index.js`'
else
  echo '       Using default Node/Express server'
  cp -r $BP_DIR/server $BP_DIR/package.json $BP_DIR/package-lock.json $BUILD_DIR/
fi

shopt -u dotglob

echo "-----> Configure environments"
export_env_dir() {
  local env_dir=$1
  local whitelist_regex=${2:-''}
  local blacklist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH|IFS)$'}
  if [ -d "$env_dir" ]; then
    for e in $(ls $env_dir); do
      echo "$e" | grep -E "$whitelist_regex" | grep -qvE "$blacklist_regex" &&
      export "$e=$(cat $env_dir/$e)"
      :
    done
  fi
}

echo '       Enabling runtime environment variables'

cra_dir="$BUILD_DIR/.heroku/create-react-app"
mkdir -p "$cra_dir"
cp "$BP_DIR/lib/injectable_env.rb" "$cra_dir/"

profile_d_dir="$BUILD_DIR/.profile.d"
mkdir -p "$profile_d_dir"
cp "$BP_DIR/.profile.d/inject_react_app_env.sh" "$profile_d_dir/"

cd $BP_DIR

echo '       Enabling compile-time environment variables'
# Support env vars during build:
# * `REACT_APP_*`
#   * https://github.com/facebookincubator/create-react-app/blob/v0.2.3/template/README.md#adding-custom-environment-variables
# * `NODE_*`, especially for `NODE_PATH`
#   * https://github.com/facebookincubator/create-react-app/pull/476
# * `NPM_*`, especially for `NPM_TOKEN`
#   * https://docs.npmjs.com/private-modules/ci-server-config
export_env_dir "$ENV_DIR" '^(REACT_APP_|NODE_|NPM_)'

echo "-----> Downloading buildpack: $url"
if [[ "$url" =~ \.tgz$ ]] || [[ "$url" =~ \.tgz\? ]]; then
  mkdir -p "$dir"
  curl -s "$url" | tar xvz -C "$dir" >/dev/null 2>&1
else
  git clone $url $dir >/dev/null 2>&1
fi
cd $dir

if [ "$branch" != "" ]; then
  git checkout $branch >/dev/null 2>&1
fi

chmod -f +x $dir/bin/{detect,compile,release}

framework=$($dir/bin/detect $1)

if [ $? == 0 ]; then
  $dir/bin/compile $BUILD_DIR $CACHE_DIR $ENV_DIR

  if [ $? != 0 ]; then
    exit 1
  fi
else
  echo "create-react-app requires `package.json`"
  exit 1
fi
